<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <link rel="icon" href="favicon.ico">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        
        <title>Wikie-Pooh</title>
        <script src = "/socket.io/socket.io.js"> </script>
        
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0/handlebars.js"></script>
        <script type=text/javascript src="//code.jquery.com/jquery-2.1.1.min.js"></script>
        
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
        
        <!-- Optional theme -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
        
        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

        <script id="entry-template" type="x-handlebars-template">
			<td>{{index}}</td>
			<td>
				{{link entry}}
				<button 
					type="button" 
					class="btn btn-xs btn-default" 
					onClick="moreContent(+100,'{{entry}}')"
					{{#unless content}}disabled{{/unless}} 
				>+</button>
				<button 
					type="button" 
					class="btn btn-xs btn-default" 
					onClick="moreContent(-100,'{{entry}}')"
					{{#unless content}}disabled{{/unless}} 
				>-</button>
				<div style="float: right; clear: right; margin: 10px;">
					<button 
						type="button" 
						class="btn btn-xs btn-default" 
						id="btn-load-{{clean_id}}" 
						onClick="socket.emit('loadEntry', '{{entry}}')"
						{{#if content}}disabled{{/if}} 
						{{#if not_found}}disabled{{/if}} 
					>Load</button>
					<button 
						type="button" 
						class="btn btn-xs btn-default" 
						id="btn-parse-{{clean_id}}" 
						onClick="socket.emit('parseEntry', '{{entry}}')"
						{{#unless content}}disabled{{/unless}} 
					>Parse</button>
				</div>
				<div id="content-{{clean_id}}"></div>
			</td>
			<td>{{#if not_found}}<font color="red">not found</font> ({{pageid}}){{else}}{{pageid}}{{/if}}</td>
			<td>{{#sources}}{{link this}} {{/sources}}</td>
			<td>{{heirs}}</td>
			<td><textarea id="comment-{{clean_id}}" class="form-control" rows="2" onkeydown="commentKeyEvent(event, '{{entry}}')">{{comment}}</textarea></td>
        </script>
        
        <script id="entries-template" type="x-handlebars-template">
            <table border="1" class="table table-bordered">
            <thead>
                <tr>
					<th>#</th>
                    <th>Entry</th>
                    <th>PageId</th>
                    <th>Sources</th>
                    <th>#cats</th>
                    <th>Comment</th>
                </tr>
            </thead>
            <tbody>
                {{#this}}
		        <tr id="tr-{{this.clean_id}}" class="entry">
					{{> entry_row}}
				</tr>
                {{/this}}
            </tbody>
            </table>
        </script>

        <script id="pgtitle-template" type="x-handlebars-template">
			File: <strong>{{name}}</strong> 
			Lang: <strong>{{lang}}</strong> 
			entries: <strong>{{entry_count}}</strong>
        </script>
        
        <script>
        
        	var expInfo; /* general information about the experiment */
        	
        	/* Handlebars templates */
        	
            var entriesTemplateScript = $("#entries-template").html(); 
            var entriesTemplate = Handlebars.compile (entriesTemplateScript); 
            var entryTemplateScript = $("#entry-template").html(); 
            var entryTemplate = Handlebars.compile (entryTemplateScript); 
            Handlebars.registerPartial("entry_row", $("#entry-template").html());
            
            var pgtitleTemplateScript = $("#pgtitle-template").html(); 
            var pgtitleTemplate = Handlebars.compile (pgtitleTemplateScript); 
            
            Handlebars.registerHelper('link', function(entry) {
  				var url = Handlebars.escapeExpression(expInfo.uri + entry),
  					text = Handlebars.escapeExpression(entry);

  				return new Handlebars.SafeString(
    				"<a href='" + url + "'>" + text + "</a>"
  				);
			});
			
			/* setup connection to servlets */
			
            var socket = io.connect();
            
            socket.on("pgtitle", showPgtitle);
            socket.on("entryList", showEntryList);
            socket.on("updateEntry", updateEntry);

			/** hash of all entries */
			var entryMap = [];
			     	   
			/**
			 * Adds entry fiields that are neccessary for page operation.
			 */
			function fixEntry(entry) {
				entry.clean_id = entry.entry.replace(/[()\s\.]/gi, '')
          		if (entry.pageid && entry.pageid <= 1) 
           			entry.not_found = true;
           			
           		/* copy some of the important parameters from if the entry alreay in the list */
           		if (entryMap[entry.entry]) {
           			entry.index = entryMap[entry.entry].index
           		}
           		return entry;
			}
						
            function showEntryList(msg) {
            	for(var i=0; i<msg.length; ++i) {
            		msg[i] = fixEntry(msg[i]);
            		msg[i].index = i+1;
            		entryMap[msg[i].entry] = msg[i];
            	}
                $("#entryTable").html(entriesTemplate(msg));
            }

			function updateEntry(msg) {
           		msg = fixEntry(msg);
				entryMap[msg.entry] = msg;
				$("#tr-" + msg.clean_id).html(entryTemplate(msg));
			}
			
            function showPgtitle(msg) {
            	expInfo = msg;
                $("#pgtitle").html(pgtitleTemplate(msg));
                
	            socket.emit('getEntryList');
            }
            
            socket.emit('getPgtitle');
            
            function moreContent( increment, entry ) {
            	if (entryMap[entry] && entryMap[entry].content) {
            		if (entryMap[entry].content_sz)
            			entryMap[entry].content_sz += increment;
            		else
            			entryMap[entry].content_sz = increment;

					var elps = '';
            		if (entryMap[entry].content_sz < 0)
            			entryMap[entry].content_sz = 0;
 					else if (entryMap[entry].content_sz > entryMap[entry].content.length)        			
            			entryMap[entry].content_sz = entryMap[entry].content.length;
            		else
            			elps = '...';
            			
            		$("#content-" + entryMap[entry].clean_id).html(entryMap[entry].content.substring(0, entryMap[entry].content_sz) + elps); 	
            	}	
            }
            
            function commentKeyEvent(event, entry_name) {
            	var el = $('#comment-' + entryMap[entry_name].clean_id);
            	if (event.keyCode == 13) /* enter pressed */ {
            		/* change bg color to green */
            		el.css('background-color' , '#00FF00');
            		
            		/* send comment to server */
            		socket.emit('updateComment', { 'entry' : entry_name, 'comment' : el.val() });
            	} else {
            		/* set backgorund to red */
            		el.css('background-color' , '#FF0000');
            	}
            }
        </script>
    </head>
    
    <body role="document">

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Wikie-Pooh</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#status">Status</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
    
    <div class="container theme-showcase" role="main">
    
         <div class="jumbotron">
            <h1 id="pgtitle">
            	loading
            	<blink>...</blink>
            </h1>
        </div>
        
        <div class="page-header">
            <h2 id="entries">List of Entries</h2>
        </div>
        
        <div id="entryTable">
        	loading
        	<blink>...</blink>
        </div>

    </div>
    </body>
</html>